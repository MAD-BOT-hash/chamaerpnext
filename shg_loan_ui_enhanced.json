{
  "doctype": "Client Script",
  "dt": "SHG Loan",
  "enabled": 1,
  "view": "Form",
  "script": "frappe.provide('shg.ui');\n\n(function(){\n  // --- THEME (Blue) ------------------------------------------------------\n  const THEME_ID = 'theme-shg-blue';\n  const CSS = `\n    :root { --shg-accent: #79B6F2; --shg-accent-ink:#0b5aa8; }\n    .shg-pill {background: var(--shg-accent); color: #fff; padding:2px 8px; border-radius: 12px; font-weight:600;}\n    .shg-dash-total {font-weight:600;}\n    .shg-muted {opacity:.8}\n    .indicator-blue {background: var(--shg-accent)!important}\n  `;\n  function injectTheme(){\n    if (!document.getElementById(THEME_ID)){\n      const s=document.createElement('style'); s.id=THEME_ID; s.appendChild(document.createTextNode(CSS)); document.head.appendChild(s);\n    }\n  }\n\n  // --- HELPERS ------------------------------------------------------------\n  function sumField(rows, field){\n    return (rows||[]).reduce((t,r)=>t + (flt(r[field])||0), 0);\n  }\n  function flt(x){ const v=parseFloat(x); return isNaN(v)?0:v; }\n  function formatMoney(v, currency){ return format_currency(flt(v), currency || (frappe.boot.sysdefaults.currency || 'KES')); }\n\n  function computeScheduleTotals(frm){\n    const rows = frm.doc.repayment_schedule || [];\n    return {\n      principal: sumField(rows, 'principal_amount') || sumField(rows, 'principal_component'),\n      interest: sumField(rows, 'interest_amount') || sumField(rows, 'interest_component'),\n      total_payment: sumField(rows, 'total_payment'),\n      total_due: sumField(rows, 'total_due'),\n      amount_paid: sumField(rows, 'amount_paid'),\n      unpaid_balance: sumField(rows, 'unpaid_balance'),\n      loan_balance: sumField(rows, 'loan_balance')\n    };\n  }\n\n  function percentRepaid(frm){\n    const total = flt(frm.doc.total_payable) || 0;\n    const paid  = flt(frm.doc.total_repaid) || 0;\n    if (total<=0) return 0; return Math.max(0, Math.min(100, Math.round((paid/total)*100)));\n  }\n\n  function headlineOutstanding(frm){\n    const outstanding = (flt(frm.doc.total_payable) - flt(frm.doc.total_repaid));\n    const txt = `ðŸ”µ Outstanding: <span class=\"shg-pill\">${formatMoney(outstanding, frm.doc.currency)}</span>`;\n    frm.dashboard.set_headline(txt);\n  }\n\n  function drawProgress(frm){\n    const pct = percentRepaid(frm);\n    const msg = `${pct}% repaid`;\n    frm.dashboard.add_progress(__('Repayment Progress'), pct, msg);\n  }\n\n  function drawTotals(frm){\n    const t = computeScheduleTotals(frm);\n    const html = `\n      <div class=\"mt-2\">\n        <div class=\"shg-dash-total\">Schedule Totals</div>\n        <div class=\"shg-muted\">Principal: ${formatMoney(t.principal)} Â· Interest: ${formatMoney(t.interest)} Â· Paid: ${formatMoney(t.amount_paid)} Â· Unpaid: ${formatMoney(t.unpaid_balance)}</div>\n      </div>`;\n    frm.dashboard.clear_headline();\n    headlineOutstanding(frm);\n    frm.dashboard.add_section(html);\n    drawProgress(frm);\n  }\n\n  function safeRefreshServer(frm){\n    // Try your server refresh method if present; fall back to client-only recompute\n    frappe.call({\n      method: 'shg.shg.doctype.shg_loan.shg_loan.refresh_repayment_summary',\n      args: { loan_name: frm.doc.name },\n      freeze: true,\n      callback: () => { frm.reload_doc(); }\n    }).catch(()=>{\n      // fallback: just recompute the dashboard pieces from current grid\n      drawTotals(frm);\n      frappe.show_alert({message: __('Summary refreshed locally'), indicator: 'blue'});\n    });\n  }\n\n  // --- BIND FORM EVENTS ---------------------------------------------------\n  frappe.ui.form.on('SHG Loan', {\n    setup(frm){ injectTheme(); },\n    refresh(frm){\n      injectTheme();\n      // Header indicator + totals\n      frm.dashboard.clear();\n      headlineOutstanding(frm);\n      drawTotals(frm);\n\n      // Add refresh button (works on Draft & Submitted)\n      if (!frm.custom_buttons_added){\n        frm.add_custom_button('ðŸ”„ Refresh Details', ()=> safeRefreshServer(frm), 'Actions');\n        frm.custom_buttons_added = true;\n      }\n\n      // Submitted info notice\n      if (frm.doc.docstatus === 1){\n        frappe.show_alert({ message: __('ðŸ”’ Submitted â€” repayments still allowed, other edits limited.'), indicator: 'orange' });\n      }\n    },\n    // On child table change, recompute quick totals live\n    repayment_schedule_on_form_rendered(frm){ drawTotals(frm); },\n    after_save(frm){ drawTotals(frm); },\n    on_submit(frm){ drawTotals(frm); }\n  });\n})();\n"
}